# HES-Kaifa Kafka Consumer

A Python Kafka consumer that consumes SOAP messages from the `hes-kaifa-outage-topic` and transforms them into JSON format, storing them in dedicated JSON files.

## Features

- **Kafka Consumer**: Consumes messages from `hes-kaifa-outage-topic`
- **SOAP to JSON Transformation**: Converts SOAP XML messages to structured JSON
- **File Storage**: Saves transformed messages to individual JSON files
- **Error Handling**: Robust error handling and logging
- **Configurable**: Environment variables and command-line options
- **Testing**: Comprehensive unit tests included

## Installation

1. Install required dependencies:
```bash
pip install -r ../requirements.txt
```

2. Ensure Kafka is running and accessible
3. Verify the `hes-kaifa-outage-topic` topic exists

## Usage

### Basic Usage

Run the consumer with default settings:
```bash
python run_consumer.py
```

### Advanced Usage

```bash
python run_consumer.py \
    --bootstrap-servers localhost:9092 \
    --topic hes-kaifa-outage-topic \
    --output-dir ./output \
    --group-id my-consumer-group \
    --log-level INFO
```

### Environment Variables

You can also configure the consumer using environment variables:

```bash
export KAFKA_BOOTSTRAP_SERVERS=localhost:9092
export KAFKA_TOPIC=hes-kaifa-outage-topic
export OUTPUT_DIR=./output
export KAFKA_GROUP_ID=hes-kaifa-consumer-group
export LOG_LEVEL=INFO

python run_consumer.py
```

## Configuration

### Command Line Options

- `--bootstrap-servers`: Kafka bootstrap servers (default: localhost:9092)
- `--topic`: Kafka topic to consume from (default: hes-kaifa-outage-topic)
- `--output-dir`: Output directory for JSON files (default: apisix-workshop/Kaifa-HES-Events)
- `--group-id`: Kafka consumer group ID (default: hes-kaifa-consumer-group)
- `--log-level`: Logging level (default: INFO)
- `--test-mode`: Run in test mode (process one message and exit)
- `--dry-run`: Dry run mode (don't save files, just process messages)

### Environment Variables

- `KAFKA_BOOTSTRAP_SERVERS`: Kafka bootstrap servers
- `KAFKA_TOPIC`: Kafka topic name
- `OUTPUT_DIR`: Output directory for JSON files
- `KAFKA_GROUP_ID`: Kafka consumer group ID
- `LOG_LEVEL`: Logging level (DEBUG, INFO, WARNING, ERROR, CRITICAL)
- `AUTO_OFFSET_RESET`: Kafka auto offset reset (latest, earliest)
- `ENABLE_AUTO_COMMIT`: Enable auto commit (true, false)
- `CONSUMER_TIMEOUT_MS`: Consumer timeout in milliseconds

## Output Format

The consumer transforms SOAP messages into structured JSON files with the following format:

```json
{
  "message_type": "EndDeviceEvent",
  "timestamp": "2025-09-22T10:46:00.000000",
  "header": {
    "verb": "Create",
    "noun": "EndDeviceEvents",
    "revision": "1.0",
    "timestamp": "2025-09-22T07:23:59.045Z",
    "source": "OMS-Traffic-Simulator",
    "async_reply_flag": "false",
    "ack_required": "false",
    "user": {
      "ns1:UserID": "simulator_user",
      "ns1:Organization": "Amman-OMS"
    },
    "message_id": "msg_1758525839045_235",
    "correlation_id": "corr_1758525839045_118",
    "comment": "Generated by OMS Traffic Simulator for Ain Ghazal"
  },
  "payload": {
    "event_id": "msg_1758525839045_236",
    "created_date_time": "2025-09-22T07:23:59.045Z",
    "issuer_id": "OMS-Simulator",
    "issuer_tracking_id": "msg_1758525839045_235",
    "reason": "Protection Trip",
    "severity": "Low",
    "user_id": "simulator_user",
    "assets": {
      "ns2:mRID": "asset_1758525839045",
      "ns2:Names": {
        "ns2:name": "Power Asset",
        "ns2:NameType": {
          "ns2:name": "Asset Name",
          "ns2:description": "Power system asset identifier"
        }
      }
    },
    "event_details": [
      {
        "ns2:name": "Current",
        "ns2:value": "101.65A"
      },
      {
        "ns2:name": "Frequency",
        "ns2:value": "49.97Hz"
      },
      {
        "ns2:name": "Power",
        "ns2:value": "1227.18kW"
      }
    ],
    "event_type": {
      "@ref": "PowerOutage"
    },
    "names": {
      "ns2:name": "Power Event",
      "ns2:NameType": {
        "ns2:name": "Event Name",
        "ns2:description": "Power system event identifier"
      }
    },
    "status": {
      "ns2:dateTime": "2025-09-22T07:23:59.045Z",
      "ns2:reason": "Protection Trip",
      "ns2:remark": "Simulated event for testing purposes",
      "ns2:value": "Active"
    },
    "usage_point": {
      "ns2:mRID": "up_1758525839045",
      "ns2:Names": {
        "ns2:name": "Ain Ghazal",
        "ns2:NameType": {
          "ns2:name": "Usage Point Name",
          "ns2:description": "Power consumption point identifier"
        }
      }
    }
  },
  "metadata": {
    "source": "hes-kaifa-outage-topic",
    "processed_at": "2025-09-22T10:46:00.000000"
  },
  "original_message": {
    "timestamp": "2025-09-22T07:23:59.072883",
    "source": "web2-hes-mock-generator",
    "topic": "hes-kaifa-outage-topic",
    "processed_at": "2025-09-22T07:23:59.072893"
  }
}
```

## File Naming Convention

JSON files are saved with the following naming convention:
```
hes_kaifa_event_YYYYMMDD_HHMMSS_message_id.json
```

Example: `hes_kaifa_event_20250922_104600_msg_1758525839045_235.json`

## Testing

Run the unit tests:
```bash
python -m pytest test_hes_kaifa_consumer.py -v
```

Or run with unittest:
```bash
python test_hes_kaifa_consumer.py
```

## Logging

The consumer creates log files in the output directory:
- `consumer.log`: Main consumer log file
- Console output: Real-time logging to console

## Error Handling

The consumer includes comprehensive error handling for:
- Kafka connection issues
- SOAP parsing errors
- File I/O errors
- Message processing errors

## Dependencies

- `kafka-python`: Kafka client library
- `xmltodict`: XML to dictionary conversion
- `lxml`: XML processing library
- `python-dateutil`: Date/time utilities

## Architecture

```
Kafka Topic (hes-kaifa-outage-topic)
    ↓
HES-Kaifa Consumer
    ↓
SOAP to JSON Transformation
    ↓
JSON File Storage (apisix-workshop/Kaifa-HES-Events/)
```

## Monitoring

The consumer provides logging and monitoring capabilities:
- Message processing statistics
- Error rates and types
- File storage metrics
- Consumer group coordination

## Troubleshooting

### Common Issues

1. **Kafka Connection Failed**
   - Verify Kafka is running
   - Check bootstrap servers configuration
   - Ensure network connectivity

2. **Topic Not Found**
   - Verify topic exists: `kafka-topics.sh --list --bootstrap-server localhost:9092`
   - Create topic if needed: `kafka-topics.sh --create --topic hes-kaifa-outage-topic --bootstrap-server localhost:9092`

3. **SOAP Parsing Errors**
   - Check message format in Kafka topic
   - Verify XML structure
   - Review consumer logs for specific errors

4. **File Storage Issues**
   - Check output directory permissions
   - Verify disk space availability
   - Review file naming conflicts

### Debug Mode

Run with debug logging:
```bash
python run_consumer.py --log-level DEBUG
```

## License

This project is part of the APISIX Workshop and follows the same licensing terms.
